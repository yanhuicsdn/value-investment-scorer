// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:../dev.db"
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  password      String?
  accounts      Account[]
  sessions      Session[]
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  scoringResults ScoringResult[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model ScoringResult {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  stockCode       String
  stockName       String
  totalScore      Float
  maxScore        Float
  scoreRatio      Float
  riskAdjustment  Float?
  isIdeal         Boolean
  useMlWeights    Boolean
  scores          String   // JSON string of detailed scores
  investmentAdvice String
  createdAt       DateTime @default(now())

  @@index([userId, createdAt])
}

// 股票数据缓存表 - 保存从 Yahoo Finance 抓取的原始数据
model StockData {
  id              String   @id @default(cuid())
  stockCode       String   @unique
  stockName       String
  stockPrice      Float
  marketCap       Float
  totalShares     Float
  peRatio         Float
  pbRatio         Float
  revenue         Float
  netIncome       Float
  ebit            Float
  operatingCashFlow Float
  totalAssets     Float
  totalLiabilities Float
  currentAssets   Float
  currentLiabilities Float
  cashEquivalents Float
  totalDebt       Float
  investedCapital Float
  roe             Float
  equityMultiplier Float
  dividendsPaid   Float
  goodwill        Float
  intangibleAssets Float
  accountsReceivable Float
  adjustedNetIncome Float
  // 原始 JSON 数据（包含所有字段）
  rawData         String   // JSON string
  // 数据来源
  dataSource      String   @default("yahoo") // yahoo, mock
  // 数据更新时间
  updatedAt       DateTime @updatedAt
  createdAt       DateTime @default(now())

  @@index([stockCode])
  @@index([updatedAt])
}
